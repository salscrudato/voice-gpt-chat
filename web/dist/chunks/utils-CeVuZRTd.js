import{n as O,p as k}from"./firebase-BDQ_IqO2.js";import{a as g}from"./components-DeDZtZlW.js";const T="voicegpt_user_name";function K(){return localStorage.getItem(T)}function V(r){const e=r.trim();return e.length<2||e.length>50?!1:(localStorage.setItem(T,e),!0)}var s;(function(r){r.INFO="info",r.WARNING="warning",r.ERROR="error",r.CRITICAL="critical"})(s||(s={}));class x{constructor(){Object.defineProperty(this,"logs",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"maxLogs",{enumerable:!0,configurable:!0,writable:!0,value:1e3})}log(e,t=s.INFO,n,a){const o={timestamp:new Date().toISOString(),severity:t,message:e,error:n,context:a,stack:n?.stack};this.logs.push(o),this.logs.length>this.maxLogs&&this.logs.shift();const l=t===s.CRITICAL?"error":t;l in console&&console[l](`[${t.toUpperCase()}] ${e}`,{error:n,context:a})}classifyError(e){const t=e?.message||String(e),n=e?.code||"UNKNOWN_ERROR";return t.includes("Network")||t.includes("fetch")?{code:"NETWORK_ERROR",message:"Network connection failed. Please check your internet connection.",severity:s.ERROR,recoverable:!0,retryAction:"retry"}:t.includes("timeout")||t.includes("Timeout")?{code:"TIMEOUT_ERROR",message:"Request timed out. Please try again.",severity:s.WARNING,recoverable:!0,retryAction:"retry"}:t.includes("401")||t.includes("Unauthorized")?{code:"AUTH_ERROR",message:"Authentication failed. Please refresh and try again.",severity:s.ERROR,recoverable:!0,retryAction:"refresh"}:t.includes("429")||t.includes("Rate limit")?{code:"RATE_LIMIT_ERROR",message:"Too many requests. Please wait a moment and try again.",severity:s.WARNING,recoverable:!0,retryAction:"wait"}:t.includes("400")||t.includes("Invalid")?{code:"VALIDATION_ERROR",message:"Invalid request. Please check your input.",severity:s.WARNING,recoverable:!1}:t.includes("500")||t.includes("Internal")?{code:"SERVER_ERROR",message:"Server error. Please try again later.",severity:s.ERROR,recoverable:!0,retryAction:"retry"}:t.includes("503")||t.includes("unavailable")?{code:"SERVICE_UNAVAILABLE",message:"Service temporarily unavailable. Please try again later.",severity:s.ERROR,recoverable:!0,retryAction:"queue"}:{code:n,message:"An unexpected error occurred. Please try again.",severity:s.WARNING,recoverable:!0,retryAction:"retry"}}getUserMessage(e){return this.classifyError(e).message||"An unexpected error occurred"}shouldRetry(e){const t=this.classifyError(e);return(t.recoverable??!1)&&t.retryAction==="retry"}getRetryDelay(e,t){const n=this.classifyError(e);return n.code==="RATE_LIMIT_ERROR"?Math.min(1e3*Math.pow(2,t),3e4):n.code==="TIMEOUT_ERROR"?Math.min(500*Math.pow(1.5,t),1e4):Math.min(1e3*Math.pow(2,t),3e4)}getLogs(){return[...this.logs]}clearLogs(){this.logs=[]}exportLogs(){return JSON.stringify(this.logs,null,2)}}const w=new x,E=(r,e)=>w.log(r,s.INFO,void 0,e),L=(r,e,t)=>w.log(r,s.WARNING,e,t),C=(r,e,t)=>w.log(r,s.ERROR,e,t);function Z(r){const n=["audio/webm","audio/mp3","audio/wav","audio/m4a","audio/mp4"];if(r.size<1024)return{valid:!1,error:"Recording is too short. Please record at least a few seconds."};if(r.size>52428800)return{valid:!1,error:`File size exceeds ${52428800/1024/1024}MB limit`};if(r.type){const a=r.type.split(";")[0];if(!n.includes(a))return{valid:!1,error:`File type ${r.type} not supported. Supported types: ${n.join(", ")}`}}return{valid:!0}}function Y(r){const e=r.trim();return e.length<2?{valid:!1,error:"Name must be at least 2 characters"}:e.length>50?{valid:!1,error:"Name must be less than 50 characters"}:/^[a-zA-Z0-9\s\-']+$/.test(e)?{valid:!0}:{valid:!1,error:"Name contains invalid characters"}}function J(r){const e=r.trim();return e.length===0?{valid:!1,error:"Message cannot be empty"}:e.length>5e3?{valid:!1,error:"Message exceeds 5000 character limit"}:{valid:!0}}async function X(){return new Promise((r,e)=>{const t=O(g,async n=>{if(t(),n)r(n);else try{const a=await k(g);r(a.user)}catch(a){e(a)}})})}async function Q(r=!1){const e=g.currentUser;if(!e)throw new Error("No authenticated user");try{return await e.getIdToken(r)}catch(t){throw console.error("Failed to get ID token:",t),t}}function B(){return g.currentUser?.uid||null}function ee(r,e){if(r.length===0)return _();let t=0,n=0,a=0;const o=.99;for(let u=0;u<r.length;u++){const m=r[u];t+=m*m,n=Math.max(n,Math.abs(m)),Math.abs(m)>o&&a++}const i=Math.sqrt(t/r.length),l=a/r.length*100,d=Array.from(r).map(Math.abs).sort((u,m)=>u-m),p=d[Math.floor(d.length*.1)],y=i>0&&p>0?20*Math.log10(i/p):0,N=p*1.5;let I=0;for(let u=0;u<r.length;u++)Math.abs(r[u])<N&&I++;const S=I/r.length*100;let h;l>1?h="clipping":i<.05?h="low":i>.7?h="high":h="optimal";let c=100;c-=Math.min(l*2,30),y<10?c-=20:y<20&&(c-=10),S>50&&(c-=15),i<.05&&(c-=20),c=Math.max(0,Math.min(100,c));let R=128;return c>80?R=192:c<50&&(R=96),{rms:i,peakLevel:n,noiseFloor:p,signalToNoise:y,clipping:l,silenceRatio:S,qualityScore:Math.round(c),recommendedBitrate:R,audioLevel:h}}function _(){return{rms:0,peakLevel:0,noiseFloor:0,signalToNoise:0,clipping:0,silenceRatio:100,qualityScore:0,recommendedBitrate:128,audioLevel:"low"}}const D={maxAttempts:3,initialDelayMs:1e3,maxDelayMs:3e4,backoffMultiplier:2,jitterFactor:.1},f=new Map,b=new Map,P=6e4;function q(r){const e=JSON.stringify(r);let t=0;for(let n=0;n<e.length;n++){const a=e.charCodeAt(n);t=(t<<5)-t+a,t=t&t}return`${Date.now()}-${Math.abs(t)}`}async function te(r,e={}){const t=e.idempotencyKey||q({}),n={...D,...e.retryConfig};if(f.has(t))return E(`Deduplicating request: ${t}`,{component:"RequestManager",action:"executeWithRetry",metadata:{deduplicated:!0}}),f.get(t);const a=b.get(t);if(a&&Date.now()-a.timestamp<P)return E(`Returning cached result for: ${t}`,{component:"RequestManager",action:"executeWithRetry",metadata:{cached:!0,age:Date.now()-a.timestamp}}),a.result;const o=U(r,n,e.timeout,e.onRetry);f.set(t,o);try{const i=await o;return b.set(t,{result:i,timestamp:Date.now()}),i}catch(i){throw i}finally{f.delete(t)}}async function U(r,e,t,n){let a=null;for(let o=0;o<e.maxAttempts;o++)try{return t?await Promise.race([r(),new Promise((l,d)=>setTimeout(()=>d(new Error(`Request timeout after ${t}ms`)),t))]):await r()}catch(i){if(a=i instanceof Error?i:new Error(String(i)),o<e.maxAttempts-1){const l=H(o,e);L(`Request attempt ${o+1} failed, retrying in ${l}ms`,a,{component:"RequestManager",action:"executeWithRetryInternal",metadata:{attempt:o+1,maxAttempts:e.maxAttempts,delayMs:l}}),n?.(o+1,a),await new Promise(d=>setTimeout(d,l))}}throw C(`Request failed after ${e.maxAttempts} attempts`,a||void 0,{component:"RequestManager",action:"executeWithRetryInternal"}),a||new Error("Max retries exceeded")}function H(r,e){const t=e.initialDelayMs*Math.pow(e.backoffMultiplier,r),n=Math.min(t,e.maxDelayMs),a=n*e.jitterFactor*Math.random();return Math.round(n+a)}class W{constructor(){Object.defineProperty(this,"listeners",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"currentState",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"healthCheckInterval",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"HEALTH_CHECK_INTERVAL_MS",{enumerable:!0,configurable:!0,writable:!0,value:3e4}),this.currentState=this.getInitialState(),this.setupListeners()}getInitialState(){const e=navigator.connection||navigator.mozConnection;return{isOnline:navigator.onLine,effectiveType:e?.effectiveType||"unknown",downlink:e?.downlink||0,rtt:e?.rtt||0,saveData:e?.saveData||!1,lastChecked:Date.now()}}setupListeners(){window.addEventListener("online",()=>this.updateState()),window.addEventListener("offline",()=>this.updateState());const e=navigator.connection||navigator.mozConnection;e&&e.addEventListener("change",()=>this.updateState()),this.startHealthChecks()}startHealthChecks(){this.healthCheckInterval=setInterval(()=>{this.performHealthCheck()},this.HEALTH_CHECK_INTERVAL_MS)}async performHealthCheck(){try{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3),n=await fetch("/health",{method:"HEAD",signal:e.signal});clearTimeout(t),!n.ok&&navigator.onLine&&console.warn("[NetworkManager] Health check failed but online status is true")}catch(e){navigator.onLine&&console.warn("[NetworkManager] Health check failed:",e)}}updateState(){const e=this.getInitialState();JSON.stringify(e)!==JSON.stringify(this.currentState)&&(this.currentState=e,console.log("[NetworkManager] Network state changed:",e),this.notifyListeners())}notifyListeners(){this.listeners.forEach(e=>{try{e(this.currentState)}catch(t){console.error("[NetworkManager] Listener error:",t)}})}getState(){return{...this.currentState}}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}isGoodForUploads(){return this.currentState.isOnline&&(this.currentState.effectiveType==="4g"||this.currentState.effectiveType==="3g")}isGoodForStreaming(){return this.currentState.isOnline&&this.currentState.effectiveType!=="slow-2g"}estimateUploadTime(e){return!this.currentState.isOnline||this.currentState.downlink===0?1/0:e*8/1e6/this.currentState.downlink*1e3}destroy(){this.healthCheckInterval&&clearInterval(this.healthCheckInterval),this.listeners.clear()}}let v=null;function re(){return v||(v=new W),v}const M=[{mimeType:"audio/webm;codecs=opus",extension:"webm",priority:1,supported:!1},{mimeType:"audio/webm",extension:"webm",priority:2,supported:!1},{mimeType:"audio/mp4",extension:"m4a",priority:3,supported:!1},{mimeType:"audio/m4a",extension:"m4a",priority:4,supported:!1},{mimeType:"audio/wav",extension:"wav",priority:5,supported:!1},{mimeType:"audio/mp3",extension:"mp3",priority:6,supported:!1},{mimeType:"audio/ogg",extension:"ogg",priority:7,supported:!1}];function A(){return M.map(r=>({...r,supported:MediaRecorder.isTypeSupported(r.mimeType)})).filter(r=>r.supported)}function F(){const r=A();return r.length>0?r[0]:null}function z(r){const e=r.split(";")[0];return M.find(t=>t.mimeType.startsWith(e))||null}function ne(r){return!r||r.size===0?{valid:!1,error:"Audio file is empty"}:r.size>500*1024*1024?{valid:!1,error:"Audio file is too large (max 500MB)"}:["audio/webm","audio/mp4","audio/m4a","audio/wav","audio/mp3","audio/ogg"].some(t=>r.type.startsWith(t))?{valid:!0}:{valid:!1,error:`Invalid audio format: ${r.type}`}}function ae(r){const e=z(r);if(e)return e.extension;const t={"audio/webm":"webm","audio/mp4":"m4a","audio/m4a":"m4a","audio/wav":"wav","audio/mp3":"mp3","audio/ogg":"ogg"},n=r.split(";")[0];return t[n]||"webm"}function ie(){const r=A(),e=F();console.log("Audio Codec Support:",{supported:r.map(t=>t.mimeType),best:e?.mimeType,all:M.map(t=>({mimeType:t.mimeType,supported:t.supported}))})}function $(r){const e=document.documentElement;e.style.colorScheme="light",e.classList.remove("dark-mode")}function se(){$()}export{E as a,F as b,ee as c,C as d,Z as e,re as f,B as g,q as h,ae as i,te as j,J as k,ie as l,Q as m,Y as n,se as o,X as p,K as q,V as s,ne as v};
