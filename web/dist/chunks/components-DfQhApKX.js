import{R as le,j as e,r as i,M as Ce,a as Ee,b as be,c as Re,d as Ie,e as Ne,f as Me,g as Te,h as Ae,i as ke}from"./react-jcPztmuw.js";import{i as Fe,g as _e,a as $e,b as De,c as ze,q as Be,o as Pe,d as Ue,r as Ve,u as qe,e as pe,s as Oe,f as Le,h as ve,j as Ge,k as He}from"./firebase-BDQ_IqO2.js";import{g as ie,l as Ke,a as re,b as Je,c as We,v as Qe,d as fe,e as Ye,f as Xe,h as Ze,i as et,j as tt,k as st,m as rt}from"./utils-IU58izPT.js";import{g as ot,a as at,b as xe,c as ye,d as we}from"./services-BPztF7Fs.js";const nt={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_CHAT_API_URL:"https://chat-api-653896399291.us-central1.run.app/chat",VITE_FIREBASE_API_KEY:"AIzaSyBVXRPB_fNCOKJmzsEU0VktPZCB_1fx8wg",VITE_FIREBASE_APP_ID:"1:653896399291:web:7722f00ce7a5961c976c9e",VITE_FIREBASE_AUTH_DOMAIN:"voice-gpt-chat.firebaseapp.com",VITE_FIREBASE_MESSAGING_SENDER_ID:"653896399291",VITE_FIREBASE_PROJECT_ID:"voice-gpt-chat",VITE_FIREBASE_STORAGE_BUCKET:"voice-gpt-chat.firebasestorage.app"};function it(){const o=["VITE_FIREBASE_API_KEY","VITE_FIREBASE_AUTH_DOMAIN","VITE_FIREBASE_PROJECT_ID","VITE_FIREBASE_STORAGE_BUCKET","VITE_FIREBASE_MESSAGING_SENDER_ID","VITE_FIREBASE_APP_ID"].filter(l=>!nt[l]);if(o.length>0)throw new Error(`Missing Firebase configuration: ${o.join(", ")}. Please check your .env.local file and ensure all required variables are set.`)}it();const ct={apiKey:"AIzaSyBVXRPB_fNCOKJmzsEU0VktPZCB_1fx8wg",authDomain:"voice-gpt-chat.firebaseapp.com",projectId:"voice-gpt-chat",storageBucket:"voice-gpt-chat.firebasestorage.app",messagingSenderId:"653896399291",appId:"1:653896399291:web:7722f00ce7a5961c976c9e"},ge=Fe(ct),ce=_e(ge),lt=$e(ge),ft=De(ge),V=le.forwardRef(({variant:u="primary",size:o="md",isLoading:l=!1,icon:x,fullWidth:y=!1,disabled:E,children:m,className:p="",...n},A)=>e.jsx("button",{ref:A,className:`btn btn-${u} btn-${o} ${y?"btn-full-width":""} ${p}`,disabled:E||l,...n,children:l?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"btn-spinner"}),"Loading..."]}):e.jsxs(e.Fragment,{children:[x&&e.jsx("span",{className:"btn-icon",children:x}),m]})}));V.displayName="Button";const dt=le.forwardRef(({children:u,hoverable:o=!1,clickable:l=!1,padding:x="md",className:y="",...E},m)=>e.jsx("div",{ref:m,className:`card card-padding-${x} ${o?"card-hoverable":""} ${l?"card-clickable":""} ${y}`,...E,children:u}));dt.displayName="Card";const he=({isOpen:u,onClose:o,title:l,children:x,size:y="md",closeOnBackdropClick:E=!0})=>{if(i.useEffect(()=>(u?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[u]),!u)return null;const m=p=>{E&&p.target===p.currentTarget&&o()};return e.jsx("div",{className:"modal-backdrop",onClick:m,children:e.jsxs("div",{className:`modal modal-${y}`,children:[l&&e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{className:"modal-title",children:l}),e.jsx("button",{className:"modal-close-btn",onClick:o,"aria-label":"Close modal",children:e.jsx(Ce,{size:24})})]}),e.jsx("div",{className:"modal-body",children:x})]})})};he.displayName="Modal";const Se=le.forwardRef(({children:u,variant:o="primary",size:l="md",icon:x,removable:y=!1,onRemove:E,className:m="",...p},n)=>e.jsxs("span",{ref:n,className:`badge badge-${o} badge-${l} ${m}`,...p,children:[x&&e.jsx("span",{className:"badge-icon",children:x}),e.jsx("span",{className:"badge-text",children:u}),y&&e.jsx("button",{className:"badge-remove",onClick:E,"aria-label":"Remove badge",children:"Ã—"})]}));Se.displayName="Badge";const ut=le.forwardRef(({label:u,error:o,helperText:l,icon:x,fullWidth:y=!1,className:E="",...m},p)=>e.jsxs("div",{className:`input-wrapper ${y?"input-full-width":""}`,children:[u&&e.jsxs("label",{className:"input-label",htmlFor:m.id,children:[u,m.required&&e.jsx("span",{className:"input-required",children:"*"})]}),e.jsxs("div",{className:"input-container",children:[x&&e.jsx("span",{className:"input-icon",children:x}),e.jsx("input",{ref:p,className:`input ${o?"input-error":""} ${x?"input-with-icon":""} ${E}`,...m})]}),o&&e.jsx("span",{className:"input-error-text",children:o}),l&&!o&&e.jsx("span",{className:"input-helper-text",children:l})]}));ut.displayName="Input";function xt({userName:u}){const[o,l]=i.useState(!1),[x,y]=i.useState(!1),[E,m]=i.useState(0),[p,n]=i.useState(null),[A,B]=i.useState([]),[_,q]=i.useState(null),[Y,$]=i.useState(!1),[k,K]=i.useState(null),[oe,X]=i.useState(0),w=i.useRef(null),O=i.useRef([]),J=i.useRef(null),Z=i.useRef(null),ae=i.useRef(0),P=i.useRef(null),ee=()=>{try{$(!0);const t=ie();if(!t){$(!1);return}const s=ze(ce,"users",t,"memos"),c=Be(s,Pe("createdAt","desc"));return Ue(c,r=>{const S=r.docs.map(N=>({id:N.id,memoId:N.data().memoId,userName:N.data().userName,transcript:N.data().transcript,createdAt:N.data().createdAt,audioSize:N.data().audioSize,tags:N.data().tags||[],status:N.data().status||"pending"}));B(S),$(!1)},r=>{console.error("Failed to load memos:",r),$(!1)})}catch(t){console.error("Failed to load memos:",t),$(!1)}};i.useEffect(()=>{const t=ee();return()=>{t&&t()}},[]);const a=async()=>{try{Ke();const t={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:{ideal:48e3,min:16e3},channelCount:{ideal:1}}},s=await navigator.mediaDevices.getUserMedia(t),c=s.getAudioTracks()[0];if(c){const h=c.getSettings?.();re("Audio recording settings",{component:"UploadRecorder",action:"startRecording",metadata:{sampleRate:h?.sampleRate,channelCount:h?.channelCount,echoCancellation:h?.echoCancellation,noiseSuppression:h?.noiseSuppression,autoGainControl:h?.autoGainControl}})}const v=new(window.AudioContext||window.webkitAudioContext);J.current=v;const r=v.createMediaStreamSource(s),S=v.createAnalyser();S.fftSize=2048,r.connect(S),Z.current=S,ae.current=Date.now(),X(0);const j=Je()?.mimeType||"";re(`Selected audio codec: ${j||"browser default"}`,{component:"UploadRecorder",action:"startRecording"});const F=new MediaRecorder(s,j?{mimeType:j}:{});F.ondataavailable=h=>{h.data.size>0&&O.current.push(h.data)},F.onerror=h=>{console.error("MediaRecorder error:",h.error),n({type:"error",text:`Recording error: ${h.error}`}),l(!1),s.getTracks().forEach(D=>D.stop()),P.current&&clearInterval(P.current)},F.start(1e3),w.current=F,l(!0),n(null),Z.current&&(P.current=setInterval(()=>{const h=Z.current;if(h){const f=new Uint8Array(h.frequencyBinCount);h.getByteFrequencyData(f);const R=new Float32Array(f.length);for(let M=0;M<f.length;M++)R[M]=(f[M]-128)/128;const C=We(R,48e3);K(C)}const D=Math.floor((Date.now()-ae.current)/1e3);X(D)},500))}catch(t){const s=t.message||"Failed to start recording";console.error("Recording start error:",t);let c=s;s.includes("NotAllowedError")?c="Microphone access denied. Please allow microphone access in your browser settings.":s.includes("NotFoundError")?c="No microphone found. Please connect a microphone and try again.":s.includes("NotReadableError")&&(c="Microphone is in use by another application. Please close other apps using the microphone."),n({type:"error",text:c})}},d=async()=>{if(!w.current)return;const t=w.current;P.current&&(clearInterval(P.current),P.current=null),J.current&&(J.current.close(),J.current=null),console.log("Stopping recording. Chunks collected:",O.current.length),t.stream.getTracks().forEach(r=>{r.stop()}),await new Promise(r=>{t.onstop=()=>{console.log("MediaRecorder stopped. Final chunks:",O.current.length),r()},t.stop()});const c=(t.mimeType||"audio/webm").split(";")[0],v=new Blob(O.current,{type:c});console.log("Audio blob created. Size:",v.size,"bytes, MIME:",c),O.current=[],l(!1),await g(v)},g=async t=>{y(!0),m(0);let s=Date.now();try{re(`Starting audio upload. Size: ${t.size} bytes, type: ${t.type}`,{component:"UploadRecorder",action:"uploadAudio"});const c=Qe(t);if(!c.valid){fe("Audio blob validation failed",new Error(c.error),{component:"UploadRecorder",action:"uploadAudio"}),n({type:"error",text:c.error||"Invalid audio file"}),y(!1);return}const v=Ye(t);if(!v.valid){fe("Audio file validation failed",new Error(v.error),{component:"UploadRecorder",action:"uploadAudio"}),n({type:"error",text:v.error||"Invalid audio file"}),y(!1);return}re("Audio validation passed",{component:"UploadRecorder",action:"uploadAudio"});const r=ie();if(!r){n({type:"error",text:"User not authenticated"}),y(!1);return}const S=Xe(),N=S.getState();if(!N.isOnline){n({type:"error",text:"No internet connection. Please check your network."}),y(!1);return}S.isGoodForUploads()||re("Network quality is poor for uploads",{component:"UploadRecorder",action:"uploadAudio",metadata:N});const j=crypto.randomUUID(),F=Ze({uid:r,memoId:j,blobSize:t.size}),h=et(t.type);m(25);const D=`audio/${r}/${j}.${h}`,f=Ve(lt,D);await tt(async()=>qe(f,t,{customMetadata:{userName:u,memoId:j,uploadStartTime:s.toString(),audioQuality:k?k.qualityScore.toString():"unknown"}}),{idempotencyKey:F,timeout:3e5,retryConfig:{maxAttempts:3,initialDelayMs:1e3,maxDelayMs:1e4,backoffMultiplier:2,jitterFactor:.1}}),console.log("Upload successful"),m(50);const R=pe(ce,"users",r,"memos",j);console.log("Creating memo document:",{uid:r,memoId:j,audioPath:D}),await Oe(R,{memoId:j,userName:u,transcript:"",contentType:t.type,audioSize:t.size,storagePath:D,createdAt:Le(),status:"pending",indexed:!1}),console.log("Memo document created successfully"),m(75);let C=0;const M=600;let L=!1,G=!1,z=75,T=0,te=!1,H=1e3,ne=0;const de=5;for(;C<M&&!L&&!G;)try{C>30&&(H=Math.min(5e3,1e3+C*50)),await new Promise(Q=>setTimeout(Q,H)),C++;const W=pe(ce,"users",r,"memos",j);try{const Q=await ve(W);if(Q.exists()){const I=Q.data();if(ne=0,!I||typeof I!="object"){console.warn("Invalid memo data structure");continue}if((I.status==="transcribing"||I.status==="transcribed"||I.status==="error")&&(te=!0),I.status==="error"){G=!0;const se=I.errorMessage||"Unknown error",ue=I.errorDetails?` (${I.errorDetails})`:"";n({type:"error",text:`Transcription failed: ${String(se).substring(0,100)}${ue}`})}else if(I.transcript&&I.status==="transcribed"){L=!0,m(100);const se=I.wordCount||0,ue=Math.round((I.confidence||0)*100),je=I.qualityScore||0;n({type:"success",text:`Memo transcribed successfully! (${se} words, ${ue}% confidence, quality: ${je}%)`})}else if(I.status==="transcribing"){const se=Math.min(20/M,.2);z=Math.min(z+se,95),m(Math.round(z)),C-T>=10&&(console.log(`Transcription in progress... (${C}s elapsed, progress: ${Math.round(z)}%)`),T=C)}}else console.warn("Memo document not found yet");C===30&&!te&&(console.warn("Cloud Function may not have been triggered. Check Firebase logs."),n({type:"error",text:"Upload processing is taking longer than expected. Cloud Function may not be deployed."}))}catch(Q){if(ne++,console.error(`Error fetching memo document (attempt ${ne}/${de}):`,Q),ne>=de)throw new Error(`Failed to fetch memo status after ${de} consecutive attempts`)}}catch(W){console.error("Error during polling:",W),G=!0,n({type:"error",text:`Polling error: ${W.message||"Unknown error"}. Please check the browser console for details.`})}if(!L&&!G)if(!te)console.error("Cloud Function not triggered. Cloud Functions may not be deployed."),n({type:"error",text:"Transcription service is not available. Please ensure Cloud Functions are deployed."});else{const W=`Transcription timed out after ${Math.round(C/60)} minutes. The audio file may be too long.`;n({type:"error",text:W})}m(0),await ee()}catch(c){n({type:"error",text:c.message||"Upload failed"})}finally{y(!1)}},b=t=>{if(!t)return"Unknown";const s=t.toDate?t.toDate():new Date(t);return s.toLocaleDateString()+" "+s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},U=async t=>{try{if(!ie()){n({type:"error",text:"User not authenticated"});return}const c=Ge();await He(c,"deleteMemo")({memoId:t.memoId}),B(A.filter(r=>r.id!==t.id)),n({type:"success",text:"Memo deleted successfully"})}catch(s){console.error("Failed to delete memo:",s),n({type:"error",text:"Failed to delete memo"})}};return e.jsxs("div",{className:"recorder-container",children:[e.jsxs("div",{className:"recorder-card",children:[e.jsx("h2",{children:"Record a Voice Memo"}),p&&e.jsx("div",{className:`message ${p.type}`,children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[p.type==="success"?e.jsx(Ee,{size:20}):e.jsx(be,{size:20}),p.text]})}),e.jsxs("div",{className:"recorder-controls",children:[e.jsxs(V,{variant:"primary",size:"md",onClick:a,disabled:o||x,children:[e.jsx("span",{style:{display:"inline-flex",alignItems:"center",marginRight:"8px"},children:e.jsx(Re,{size:20})}),o?"Recording...":"Record"]}),e.jsxs(V,{variant:"success",size:"md",onClick:d,disabled:!o||x,children:[e.jsx("span",{style:{display:"inline-flex",alignItems:"center",marginRight:"8px"},children:e.jsx(Ie,{size:20})}),"Finish"]})]}),o&&k&&e.jsxs("div",{style:{marginTop:"16px",padding:"12px",backgroundColor:"#f5f5f5",borderRadius:"8px",fontSize:"12px",fontFamily:"monospace"},children:[e.jsxs("div",{style:{marginBottom:"8px",fontWeight:"bold"},children:["Recording: ",oe,"s | Quality: ",k.qualityScore,"% | Level: ",k.audioLevel]}),e.jsxs("div",{style:{fontSize:"11px",color:"#666"},children:["SNR: ",k.signalToNoise.toFixed(1),"dB | Clipping: ",k.clipping.toFixed(1),"% | Silence: ",k.silenceRatio.toFixed(1),"%"]})]}),x&&e.jsxs("div",{className:"progress-container",children:[e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${E}%`}})}),e.jsxs("p",{children:[E,"%"]})]}),e.jsx("div",{className:"info",children:e.jsx("p",{children:"Tip: Record your thoughts, ideas, or notes. They'll be transcribed and indexed for easy searching."})})]}),e.jsxs("div",{className:"memo-history",children:[e.jsx("div",{className:"memo-history-header",children:e.jsxs("h3",{children:[e.jsx(Ne,{size:24})," Your Voice Memos (",A.length,")"]})}),Y?e.jsx("p",{className:"loading",children:"Loading memos..."}):A.length===0?e.jsx("p",{className:"empty-state",children:"No memos yet. Start recording to create your first memo!"}):e.jsx("div",{className:"memos-list",children:A.map(t=>{const s=ot(t),c=t.transcript?t.transcript.substring(0,150):"(No transcript yet)",v=t.status==="pending"?"â³ Pending":t.status==="transcribing"?"ðŸ”„ Transcribing":t.status==="error"?"âŒ Error":"âœ“ Done";return e.jsxs("div",{className:"memo-item",onClick:()=>q(t),style:{padding:"16px",background:"#f7fafc",border:"1px solid #e2e8f0",borderRadius:"8px",cursor:"pointer",transition:"all 0.3s ease"},onMouseEnter:r=>{r.currentTarget.style.background="#edf2f7",r.currentTarget.style.borderColor="#667eea",r.currentTarget.style.transform="translateX(4px)",r.currentTarget.style.boxShadow="0 4px 12px rgba(102, 126, 234, 0.2)"},onMouseLeave:r=>{r.currentTarget.style.background="#f7fafc",r.currentTarget.style.borderColor="#e2e8f0",r.currentTarget.style.transform="translateX(0)",r.currentTarget.style.boxShadow="none"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"8px"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.9em",color:"#718096",fontWeight:"600"},children:b(t.createdAt)}),e.jsxs("div",{style:{fontSize:"0.85em",color:"#a0aec0",marginTop:"4px"},children:["by ",t.userName]})]}),e.jsx("div",{style:{fontSize:"0.85em",padding:"4px 8px",background:"#667eea",color:"white",borderRadius:"4px"},children:v})]}),e.jsx("p",{style:{color:"#4a5568",fontSize:"14px",margin:"8px 0",lineHeight:"1.4"},children:c}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"12px"},children:[e.jsxs("div",{style:{fontSize:"0.85em",color:"#718096"},children:[e.jsxs("span",{children:[s.wordCount," words"]}),e.jsxs("span",{style:{marginLeft:"16px"},children:[s.readingTime," min read"]})]}),e.jsx(V,{variant:"danger",size:"sm",onClick:r=>{r.stopPropagation(),U(t)},title:"Delete memo",children:e.jsx(Me,{size:18})})]})]},t.id)})})]}),e.jsx(he,{isOpen:!!_,onClose:()=>q(null),title:"Memo Transcript",size:"md",children:_&&e.jsxs("div",{children:[e.jsxs("div",{style:{marginBottom:"16px",paddingBottom:"16px",borderBottom:"1px solid var(--border-color)"},children:[e.jsxs("p",{style:{margin:"4px 0"},children:[e.jsx("strong",{children:"Date:"})," ",b(_.createdAt)]}),e.jsxs("p",{style:{margin:"4px 0"},children:[e.jsx("strong",{children:"User:"})," ",_.userName]})]}),e.jsx("div",{style:{lineHeight:"1.6",whiteSpace:"pre-wrap",wordWrap:"break-word"},children:_.transcript}),e.jsx("div",{style:{marginTop:"20px",display:"flex",gap:"8px",justifyContent:"flex-end"},children:e.jsx(V,{variant:"primary",onClick:()=>q(null),children:"Close"})})]})})]})}const me="https://chat-api-653896399291.us-central1.run.app/chat";function yt(){const[u,o]=i.useState([]),[l,x]=i.useState(""),[y,E]=i.useState(!1),[m,p]=i.useState(null),[n,A]=i.useState(null),[B,_]=i.useState([]),[q,Y]=i.useState(!1),[$,k]=i.useState(null),[K,oe]=i.useState(null),X=i.useRef(null),w=ie(),O=()=>{X.current?.scrollIntoView({behavior:"smooth"})},J=async(a,d)=>{if(w)try{k({memoId:a,chunkIndex:d});const g=pe(ce,"users",w,"memos",a),b=await ve(g);b.exists()&&oe(b.data())}catch(g){console.error("Error fetching citation memo:",g)}};i.useEffect(()=>{(async()=>{if(w)try{const d=await at(w);if(_(d),d.length>0&&!n){A(d[0]);const g=await xe(w,d[0].id);o(g)}}catch(d){console.error("Failed to load sessions:",d)}})()},[w]),i.useEffect(()=>{O()},[u]);const Z=async()=>{if(!w){p("User not authenticated");return}try{const a=`Conversation ${new Date().toLocaleDateString()}`,d=await ye(w,a);A(d),o([]),_([d,...B]),Y(!1)}catch{p("Failed to create new session")}},ae=async a=>{if(w){A(a);try{const d=await xe(w,a.id);o(d)}catch(d){console.error("Failed to load session messages:",d),o([])}Y(!1)}},P=()=>{o([]),p(null)},ee=async()=>{if(!w){p("Not authenticated");return}const a=st(l);if(!a.valid){p(a.error||"Invalid message");return}if(!n)try{const g=`Conversation ${new Date().toLocaleDateString()}`,b=await ye(w,g);A(b),_([b,...B])}catch{p("Failed to create session");return}const d={role:"user",content:l,timestamp:new Date};o(g=>[...g,d]),x(""),E(!0),p(null);try{if(n)try{await we(w,n.id,d)}catch(s){console.error("Failed to persist user message:",s)}const g={messages:[...u,d]};let b=null;const U=3;let t=null;for(let s=0;s<U;s++)try{const c=new AbortController,v=setTimeout(()=>c.abort(),12e4);console.log(`Sending chat request (attempt ${s+1}/${U}) to:`,me);let r;try{r=await rt()}catch{throw new Error("Failed to get authorization token")}let S;try{S=await fetch(me,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(g),signal:c.signal})}catch(f){throw clearTimeout(v),f.name==="AbortError"?new Error("Chat API request timed out. The service may be overloaded."):f.message?.includes("Failed to fetch")||f.message?.includes("ERR_CONNECTION_REFUSED")?new Error(`Cannot connect to Chat API at ${me}. Make sure the Chat API service is running. Run: npm run dev in the services/chat-api directory.`):f}if(clearTimeout(v),!S.ok){const f=await S.text(),R=S.status;if(R>=400&&R<500&&R!==429)throw new Error(`API error: ${R} ${S.statusText} - ${f.substring(0,100)}`);if(R>=500||R===429){if(t=new Error(`API error: ${R} ${S.statusText}`),s<U-1){const C=Math.pow(2,s)*1e3;console.log(`Retrying after ${C}ms...`),await new Promise(M=>setTimeout(M,C));continue}throw t}throw new Error(`API error: ${R} ${S.statusText} - ${f.substring(0,100)}`)}if(!S.body)throw new Error("No response body from API");b=S.body.getReader();const N=new TextDecoder;let j="",F=[],h="";const D={role:"assistant",content:"",citations:[],timestamp:new Date};o(f=>[...f,D]);try{for(;;){const{value:f,done:R}=await b.read();if(R)break;const C=N.decode(f,{stream:!0});h+=C;const M=h.split(`

`);h=M[M.length-1];for(let L=0;L<M.length-1;L++){const G=M[L];if(G.startsWith("data:"))try{const z=G.slice(5).trim();if(!z)continue;const T=JSON.parse(z);if(T.type==="citations"&&Array.isArray(T.citations))F=T.citations;else if(T.type==="delta"&&typeof T.delta=="string")j+=T.delta,o(te=>{const H=[...te];return H.length>0&&(H[H.length-1]={role:"assistant",content:j,citations:F,timestamp:new Date}),H});else if(T.type==="done")console.log("Chat stream completed successfully");else if(T.type==="error")throw console.error("Stream error from API:",T.error),new Error(T.error||"Stream error")}catch(z){console.warn("Failed to parse stream data:",z)}}}}finally{b?.cancel()}if(n&&j)try{await we(w,n.id,{role:"assistant",content:j,citations:F})}catch(f){console.error("Failed to persist message:",f)}break}catch(c){if(t=c,console.error(`Attempt ${s+1} failed:`,c.message),b)try{b.cancel()}catch{}if(s===U-1)throw t||new Error("Failed to send message after all retries")}}catch(g){const b=g.message||"Failed to send message";p(b),o(U=>U.slice(0,-1))}finally{E(!1)}};return e.jsxs("div",{className:"chat-interface",children:[e.jsxs("div",{className:"chat-header-controls",style:{padding:"12px",borderBottom:"1px solid var(--border-color)",display:"flex",gap:"8px",alignItems:"center"},children:[e.jsxs(V,{size:"sm",variant:"secondary",onClick:()=>Y(!q),children:[q?"Hide":"Sessions"," (",B.length,")"]}),e.jsx(V,{size:"sm",variant:"primary",onClick:Z,children:"New Chat"}),u.length>0&&e.jsx(V,{size:"sm",variant:"ghost",onClick:P,icon:e.jsx(Te,{}),children:"Clear"})]}),q&&e.jsx("div",{style:{padding:"12px",borderBottom:"1px solid var(--border-color)",maxHeight:"200px",overflowY:"auto",backgroundColor:"var(--bg-secondary)"},children:B.length===0?e.jsx("p",{style:{margin:0,fontSize:"0.9em",color:"var(--text-secondary)"},children:"No sessions yet"}):B.map(a=>e.jsx("div",{onClick:()=>ae(a),style:{padding:"8px",marginBottom:"4px",backgroundColor:n?.id===a.id?"var(--primary-color)":"var(--card-bg)",color:n?.id===a.id?"white":"var(--text-primary)",borderRadius:"4px",cursor:"pointer",fontSize:"0.9em"},children:a.title},a.id))}),e.jsxs("div",{className:"messages-container",children:[u.length===0&&e.jsxs("div",{className:"empty-state",children:[e.jsx(Ae,{size:48}),e.jsx("p",{children:"Start a conversation about your voice memos!"}),e.jsx("p",{children:"Ask questions and get answers based on your recorded notes."})]}),u.map((a,d)=>e.jsx("div",{className:`message message-${a.role}`,children:e.jsxs("div",{className:`message-content message-content-${a.role}`,children:[e.jsx("div",{className:"message-text",children:a.content}),a.citations&&a.citations.length>0&&e.jsxs("div",{className:"message-citations",children:[e.jsx("div",{className:"citations-label",children:"Sources:"}),e.jsx("div",{className:"citations-list",children:a.citations.map((g,b)=>e.jsx("button",{onClick:()=>J(g.memoId,g.chunkIndex),className:"citation-button",title:"Click to view source memo",children:e.jsxs(Se,{variant:"secondary",size:"sm",children:["Memo ",g.memoId.substring(0,8),"... (chunk ",g.chunkIndex,")"]})},b))})]})]})},d)),m&&e.jsxs("div",{className:"error-message-container",children:[e.jsx(be,{size:20}),m]}),e.jsx("div",{ref:X})]}),e.jsx("div",{className:"input-container",children:e.jsxs("div",{className:"chat-input",children:[e.jsx("input",{type:"text",value:l,onChange:a=>x(a.target.value),onKeyPress:a=>a.key==="Enter"&&!y&&ee(),placeholder:"Ask about your voice memos...",disabled:y,className:"chat-input-field"}),e.jsx("button",{onClick:ee,disabled:y||!l.trim(),className:"send-btn",title:"Send message",children:e.jsx(ke,{size:18})})]})}),e.jsx(he,{isOpen:!!$&&!!K,onClose:()=>{k(null),oe(null)},title:"Source Memo",size:"md",children:K&&$&&e.jsxs("div",{children:[e.jsxs("div",{style:{marginBottom:"16px",paddingBottom:"16px",borderBottom:"1px solid var(--border-color)"},children:[e.jsxs("p",{style:{margin:"4px 0"},children:[e.jsx("strong",{children:"Chunk:"})," ",$.chunkIndex]}),e.jsxs("p",{style:{margin:"4px 0"},children:[e.jsx("strong",{children:"User:"})," ",K.userName||"Unknown"]})]}),e.jsx("div",{style:{lineHeight:"1.6",whiteSpace:"pre-wrap",wordWrap:"break-word",maxHeight:"400px",overflowY:"auto"},children:K.transcript})]})})]})}export{yt as C,xt as U,ft as a,ce as d};
