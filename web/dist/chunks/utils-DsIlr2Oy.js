import{n as N,p as O}from"./firebase-BDQ_IqO2.js";import{a as f}from"./components-CXlIrlF5.js";const T="voicegpt_user_name";function F(){return localStorage.getItem(T)}function q(r){const e=r.trim();return e.length<2||e.length>50?!1:(localStorage.setItem(T,e),!0)}var s;(function(r){r.INFO="info",r.WARNING="warning",r.ERROR="error",r.CRITICAL="critical"})(s||(s={}));class k{constructor(){Object.defineProperty(this,"logs",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"maxLogs",{enumerable:!0,configurable:!0,writable:!0,value:1e3})}log(e,t=s.INFO,n,i){const c={timestamp:new Date().toISOString(),severity:t,message:e,error:n,context:i,stack:n?.stack};this.logs.push(c),this.logs.length>this.maxLogs&&this.logs.shift();const u=t===s.CRITICAL?"error":t;u in console&&console[u](`[${t.toUpperCase()}] ${e}`,{error:n,context:i})}classifyError(e){const t=e?.message||String(e),n=e?.code||"UNKNOWN_ERROR";return t.includes("Network")||t.includes("fetch")?{code:"NETWORK_ERROR",message:"Network connection failed. Please check your internet connection.",severity:s.ERROR,recoverable:!0,retryAction:"retry"}:t.includes("timeout")||t.includes("Timeout")?{code:"TIMEOUT_ERROR",message:"Request timed out. Please try again.",severity:s.WARNING,recoverable:!0,retryAction:"retry"}:t.includes("401")||t.includes("Unauthorized")?{code:"AUTH_ERROR",message:"Authentication failed. Please refresh and try again.",severity:s.ERROR,recoverable:!0,retryAction:"refresh"}:t.includes("429")||t.includes("Rate limit")?{code:"RATE_LIMIT_ERROR",message:"Too many requests. Please wait a moment and try again.",severity:s.WARNING,recoverable:!0,retryAction:"wait"}:t.includes("400")||t.includes("Invalid")?{code:"VALIDATION_ERROR",message:"Invalid request. Please check your input.",severity:s.WARNING,recoverable:!1}:t.includes("500")||t.includes("Internal")?{code:"SERVER_ERROR",message:"Server error. Please try again later.",severity:s.ERROR,recoverable:!0,retryAction:"retry"}:t.includes("503")||t.includes("unavailable")?{code:"SERVICE_UNAVAILABLE",message:"Service temporarily unavailable. Please try again later.",severity:s.ERROR,recoverable:!0,retryAction:"queue"}:{code:n,message:"An unexpected error occurred. Please try again.",severity:s.WARNING,recoverable:!0,retryAction:"retry"}}getUserMessage(e){return this.classifyError(e).message||"An unexpected error occurred"}shouldRetry(e){const t=this.classifyError(e);return(t.recoverable??!1)&&t.retryAction==="retry"}getRetryDelay(e,t){const n=this.classifyError(e);return n.code==="RATE_LIMIT_ERROR"?Math.min(1e3*Math.pow(2,t),3e4):n.code==="TIMEOUT_ERROR"?Math.min(500*Math.pow(1.5,t),1e4):Math.min(1e3*Math.pow(2,t),3e4)}getLogs(){return[...this.logs]}clearLogs(){this.logs=[]}exportLogs(){return JSON.stringify(this.logs,null,2)}}const E=new k,W=(r,e)=>E.log(r,s.INFO,void 0,e),$=(r,e,t)=>E.log(r,s.ERROR,e,t);function j(r){const n=["audio/webm","audio/mp3","audio/wav","audio/m4a","audio/mp4"];if(r.size<1024)return{valid:!1,error:"Recording is too short. Please record at least a few seconds."};if(r.size>52428800)return{valid:!1,error:`File size exceeds ${52428800/1024/1024}MB limit`};if(r.type){const i=r.type.split(";")[0];if(!n.includes(i))return{valid:!1,error:`File type ${r.type} not supported. Supported types: ${n.join(", ")}`}}return{valid:!0}}function K(r){const e=r.trim();return e.length<2?{valid:!1,error:"Name must be at least 2 characters"}:e.length>50?{valid:!1,error:"Name must be less than 50 characters"}:/^[a-zA-Z0-9\s\-']+$/.test(e)?{valid:!0}:{valid:!1,error:"Name contains invalid characters"}}function G(r){const e=r.trim();return e.length===0?{valid:!1,error:"Message cannot be empty"}:e.length>5e3?{valid:!1,error:"Message exceeds 5000 character limit"}:{valid:!0}}async function V(){return new Promise((r,e)=>{const t=N(f,async n=>{if(t(),n)r(n);else try{const i=await O(f);r(i.user)}catch(i){e(i)}})})}async function Z(r=!1){const e=f.currentUser;if(!e)throw new Error("No authenticated user");try{return await e.getIdToken(r)}catch(t){throw console.error("Failed to get ID token:",t),t}}function J(){return f.currentUser?.uid||null}function Y(r,e){if(r.length===0)return L();let t=0,n=0,i=0;const c=.99;for(let o=0;o<r.length;o++){const d=r[o];t+=d*d,n=Math.max(n,Math.abs(d)),Math.abs(d)>c&&i++}const l=Math.sqrt(t/r.length),u=i/r.length*100,w=Array.from(r).map(Math.abs).sort((o,d)=>o-d),h=w[Math.floor(w.length*.1)],g=l>0&&h>0?20*Math.log10(l/h):0,A=h*1.5;let S=0;for(let o=0;o<r.length;o++)Math.abs(r[o])<A&&S++;const I=S/r.length*100;let m;u>1?m="clipping":l<.05?m="low":l>.7?m="high":m="optimal";let a=100;a-=Math.min(u*2,30),g<10?a-=20:g<20&&(a-=10),I>50&&(a-=15),l<.05&&(a-=20),a=Math.max(0,Math.min(100,a));let y=128;return a>80?y=192:a<50&&(y=96),{rms:l,peakLevel:n,noiseFloor:h,signalToNoise:g,clipping:u,silenceRatio:I,qualityScore:Math.round(a),recommendedBitrate:y,audioLevel:m}}function L(){return{rms:0,peakLevel:0,noiseFloor:0,signalToNoise:0,clipping:0,silenceRatio:100,qualityScore:0,recommendedBitrate:128,audioLevel:"low"}}const p=new Map,b=new Map,C=6e4;async function X(r,e={}){const t=e.idempotencyKey||_({});if(p.has(t))return p.get(t);const n=b.get(t);if(n&&Date.now()-n.timestamp<C)return n.result;const i=r();p.set(t,i);try{const c=await i;return b.set(t,{result:c,timestamp:Date.now()}),c}finally{p.delete(t)}}function _(r){const e=JSON.stringify(r);let t=0;for(let n=0;n<e.length;n++){const i=e.charCodeAt(n);t=(t<<5)-t+i,t=t&t}return`${Date.now()}-${Math.abs(t)}`}class x{constructor(){Object.defineProperty(this,"listeners",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"currentState",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"healthCheckInterval",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"HEALTH_CHECK_INTERVAL_MS",{enumerable:!0,configurable:!0,writable:!0,value:3e4}),this.currentState=this.getInitialState(),this.setupListeners()}getInitialState(){const e=navigator.connection||navigator.mozConnection;return{isOnline:navigator.onLine,effectiveType:e?.effectiveType||"unknown",downlink:e?.downlink||0,rtt:e?.rtt||0,saveData:e?.saveData||!1,lastChecked:Date.now()}}setupListeners(){window.addEventListener("online",()=>this.updateState()),window.addEventListener("offline",()=>this.updateState());const e=navigator.connection||navigator.mozConnection;e&&e.addEventListener("change",()=>this.updateState()),this.startHealthChecks()}startHealthChecks(){this.healthCheckInterval=setInterval(()=>{this.performHealthCheck()},this.HEALTH_CHECK_INTERVAL_MS)}async performHealthCheck(){try{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3),n=await fetch("/health",{method:"HEAD",signal:e.signal});clearTimeout(t),!n.ok&&navigator.onLine&&console.warn("[NetworkManager] Health check failed but online status is true")}catch(e){navigator.onLine&&console.warn("[NetworkManager] Health check failed:",e)}}updateState(){const e=this.getInitialState();JSON.stringify(e)!==JSON.stringify(this.currentState)&&(this.currentState=e,console.log("[NetworkManager] Network state changed:",e),this.notifyListeners())}notifyListeners(){this.listeners.forEach(e=>{try{e(this.currentState)}catch(t){console.error("[NetworkManager] Listener error:",t)}})}getState(){return{...this.currentState}}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}isGoodForUploads(){return this.currentState.isOnline&&(this.currentState.effectiveType==="4g"||this.currentState.effectiveType==="3g")}isGoodForStreaming(){return this.currentState.isOnline&&this.currentState.effectiveType!=="slow-2g"}estimateUploadTime(e){return!this.currentState.isOnline||this.currentState.downlink===0?1/0:e*8/1e6/this.currentState.downlink*1e3}destroy(){this.healthCheckInterval&&clearInterval(this.healthCheckInterval),this.listeners.clear()}}let v=null;function Q(){return v||(v=new x),v}const R=[{mimeType:"audio/webm;codecs=opus",extension:"webm",priority:1,supported:!1},{mimeType:"audio/webm",extension:"webm",priority:2,supported:!1},{mimeType:"audio/mp4",extension:"m4a",priority:3,supported:!1},{mimeType:"audio/m4a",extension:"m4a",priority:4,supported:!1},{mimeType:"audio/wav",extension:"wav",priority:5,supported:!1},{mimeType:"audio/mp3",extension:"mp3",priority:6,supported:!1},{mimeType:"audio/ogg",extension:"ogg",priority:7,supported:!1}];function M(){return R.map(r=>({...r,supported:MediaRecorder.isTypeSupported(r.mimeType)})).filter(r=>r.supported)}function H(){const r=M();return r.length>0?r[0]:null}function P(r){const e=r.split(";")[0];return R.find(t=>t.mimeType.startsWith(e))||null}function B(r){return!r||r.size===0?{valid:!1,error:"Audio file is empty"}:r.size>500*1024*1024?{valid:!1,error:"Audio file is too large (max 500MB)"}:["audio/webm","audio/mp4","audio/m4a","audio/wav","audio/mp3","audio/ogg"].some(t=>r.type.startsWith(t))?{valid:!0}:{valid:!1,error:`Invalid audio format: ${r.type}`}}function ee(r){const e=P(r);if(e)return e.extension;const t={"audio/webm":"webm","audio/mp4":"m4a","audio/m4a":"m4a","audio/wav":"wav","audio/mp3":"mp3","audio/ogg":"ogg"},n=r.split(";")[0];return t[n]||"webm"}function te(){const r=M(),e=H();console.log("Audio Codec Support:",{supported:r.map(t=>t.mimeType),best:e?.mimeType,all:R.map(t=>({mimeType:t.mimeType,supported:t.supported}))})}function U(r){const e=document.documentElement;e.style.colorScheme="light",e.classList.remove("dark-mode")}function re(){U()}export{W as a,H as b,Y as c,$ as d,j as e,Q as f,J as g,_ as h,ee as i,X as j,G as k,te as l,Z as m,K as n,re as o,V as p,F as q,q as s,B as v};
