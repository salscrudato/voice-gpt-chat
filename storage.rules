rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Helper functions
    function isValidUserId(uid) {
      // Accept any non-empty uid (Firebase auth generates standard UUIDs)
      return uid is string && uid.size() > 0;
    }

    function isValidAudioFile(memoId) {
      // Accept UUID with or without extension
      return memoId is string && memoId.size() > 0;
    }

    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    function isValidAudioType() {
      // Check if content type starts with audio/ (handles audio/webm, audio/webm;codecs=opus, etc.)
      return request.resource.contentType.matches('^audio/.*');
    }

    // Audio uploads: allow authenticated users to upload their own audio
    match /audio/{uid}/{memoId} {
      // Read: allow owner to read audio files
      allow read: if isValidUserId(uid) && isOwner(uid);

      // Write: allow authenticated users to upload their own audio
      allow write: if isValidUserId(uid) &&
                      isOwner(uid) &&
                      isValidAudioFile(memoId) &&
                      request.resource.size < 50 * 1024 * 1024 &&  // 50 MB limit
                      isValidAudioType();

      // Delete: allow owner to delete
      allow delete: if isValidUserId(uid) && isOwner(uid);
    }

    // Deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
